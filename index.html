<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interbelief Chat Lobby</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; }
    fieldset { margin: 1em 0; }
    ul { list-style: none; padding: 0; }
    li { padding: .5em; border: 1px solid #ddd; margin-bottom: .5em; }
    button { margin-left: .5em; }
  </style>
</head>
<body>

  <h1>Interbelief Chat</h1>

  <!-- 1) SIGN-UP / LOGIN UI -->
  <fieldset id="auth-fieldset">
    <legend>Account</legend>

    <!-- Create Account Toggle -->
    <button onclick="toggleSignup()">Create Account</button>
    <div id="signup-ui" style="display:none; margin-top:1em;">
      <h3>Sign Up</h3>
      <input id="su-username" type="text" placeholder="Username" /><br/>
      <input id="su-email" type="email" placeholder="Email" /><br/>
      <input id="su-pass"  type="password" placeholder="Password" /><br/>
      <button onclick="signUp()">Submit</button>
    </div>

    <hr/>

    <div id="login-ui">
      <h3>Log In</h3>
      <input id="li-email" type="email" placeholder="Email" /><br/>
      <input id="li-pass"  type="password" placeholder="Password" /><br/>
      <button onclick="signIn()">Log In</button>
    </div>

    <div id="user-info" style="display:none;">
      Logged in as <strong id="user-username"></strong> (<span id="user-email"></span>)
      <button onclick="signOut()">Sign Out</button>
    </div>
  </fieldset>

  <!-- 2) ROOM CREATION & LISTING -->
  <fieldset id="room-fieldset" style="display:none;">
    <legend>Room Dashboard</legend>

    <h3>Create a Room</h3>
    <label for="room-target">Looking for: </label>
    <select id="room-target">
      <option value="Christian">âœï¸ Christian</option>
      <option value="Catholic">â›ª Catholic</option>
      <option value="Muslim">â˜ªï¸ Muslim</option>
      <option value="Hindu">ğŸ•‰ï¸ Hindu</option>
      <option value="Jewish">âœ¡ï¸ Jewish</option>
      <option value="Buddhist">â˜¸ï¸ Buddhist</option>
      <option value="Sikh">â˜¬ Sikh</option>
      <option value="Atheist">ğŸš« Atheist</option>
      <option value="Agnostic">â“ Agnostic</option>
      <option value="Deist">ğŸ”† Deist</option>
    </select>
    <label for="room-cap">Capacity: </label>
    <input id="room-cap" type="number" min="2" max="20" value="4" style="width:4em;" />
    <button onclick="createRoom()">Create</button>

    <h3>Available Rooms</h3>
    <ul id="room-list"></ul>
  </fieldset>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
  <script>
    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      databaseURL: "https://bible-game-246c0-default-rtdb.firebaseio.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.firebasestorage.app",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1",
      measurementId: "G-8PR6LVKSH3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    let currentUser = null;

    // Toggle signup form
    function toggleSignup() {
      const ui = document.getElementById('signup-ui');
      ui.style.display = ui.style.display === 'none' ? 'block' : 'none';
    }

    // AUTH HANDLERS
    function signUp() {
      const username = document.getElementById('su-username').value;
      const email    = document.getElementById('su-email').value;
      const pass     = document.getElementById('su-pass').value;
      auth.createUserWithEmailAndPassword(email, pass)
        .then(({ user }) => db.ref(`members/${user.uid}`).set({ username }))
        .catch(err => alert(err.message));
    }

    function signIn() {
      const email = document.getElementById('li-email').value;
      const pass  = document.getElementById('li-pass').value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => alert(err.message));
    }

    function signOut() {
      auth.signOut();
    }

    auth.onAuthStateChanged(async user => {
      currentUser = user;
      document.getElementById('signup-ui').style.display   = 'none';
      document.getElementById('login-ui').style.display    = user ? 'none' : '';
      document.getElementById('user-info').style.display   = user ? '' : 'none';
      document.getElementById('room-fieldset').style.display = user ? '' : 'none';
      if (!user) return;

      // display user info
      const snap    = await db.ref(`members/${user.uid}`).once('value');
      const profile = snap.val();
      document.getElementById('user-username').textContent = profile.username;
      document.getElementById('user-email').textContent    = user.email;

      loadRooms(profile.username);
    });

    // CREATE ROOM
    async function createRoom() {
      const target   = document.getElementById('room-target').value;
      const capacity = +document.getElementById('room-cap').value;
      const roomRef  = db.ref('rooms').push();
      await roomRef.set({
        host: currentUser.uid,
        targetBelief: target,
        capacity,
        members: { [currentUser.uid]: true },
        started: false,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
      loadRooms();
    }

    // LOAD & DISPLAY ROOMS
    async function loadRooms(myBelief) {
      const listEl = document.getElementById('room-list');
      listEl.innerHTML = '';
      const snap = await db.ref('rooms').once('value');
      const rooms = [];
      snap.forEach(child => {
        const r = child.val();
        r.id = child.key;
        r.memberCount = r.members ? Object.keys(r.members).length : 0;
        if (r.memberCount < r.capacity || r.host === currentUser.uid) rooms.push(r);
      });

      rooms.sort((a, b) => {
        const aPref = (a.targetBelief === myBelief) ? 0 : 1;
        const bPref = (b.targetBelief === myBelief) ? 0 : 1;
        return aPref - bPref || (a.createdAt - b.createdAt);
      });

      for (const r of rooms) {
        const li = document.createElement('li');
        li.id = `room-${r.id}`;
        li.innerHTML = `Host: ${r.host}<br/>Looking for: ${r.targetBelief} (${r.memberCount}/${r.capacity})<br/>`;

        if (r.host === currentUser.uid) {
          // show members
          li.innerHTML += '<strong>Members:</strong><ul>';
          for (const uid of Object.keys(r.members)) {
            const memberSnap = await db.ref(`members/${uid}`).once('value');
            li.innerHTML += `<li>${memberSnap.val().username}</li>`;
          }
          li.innerHTML += '</ul>';
          // start button
          if (!r.started) {
            const startBtn = document.createElement('button');
            startBtn.textContent = 'Start Lobby';
            startBtn.onclick = () => startRoom(r.id);
            li.appendChild(startBtn);
          }
        } else if (r.members && r.members[currentUser.uid]) {
          // joined, wait for start
          const status = document.createElement('span');
          status.id = `status-${r.id}`;
          status.textContent = 'Joined. Waiting for host to start...';
          li.appendChild(status);
          waitForStart(r.id);
        } else {
          // join button
          const joinBtn = document.createElement('button');
          joinBtn.textContent = 'Join';
          joinBtn.onclick = () => joinRoom(r.id);
          li.appendChild(joinBtn);
        }

        listEl.appendChild(li);
      }
    }

    // JOIN & WAIT
    function joinRoom(roomId) {
      db.ref(`rooms/${roomId}/members/${currentUser.uid}`).set(true)
        .then(() => loadRooms());
    }
    function waitForStart(roomId) {
      db.ref(`rooms/${roomId}/started`).on('value', snap => {
        if (snap.val()) {
          window.location.href = `chatroom.html?roomId=${roomId}`;
        }
      });
    }

    // START ROOM
    async function startRoom(roomId) {
      await db.ref(`rooms/${roomId}`).update({ started: true });
      window.location.href = `chatroom.html?roomId=${roomId}`;
    }
  </script>
</body>
</html>
